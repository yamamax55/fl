# 開発ログ - Galaxy RTS

## 最新更新（Phase 5拡張）
- [x] 戦闘時滑らか回転システム実装
  - `updateFacing()`メソッドを滑らかな回転に変更
  - 戦闘時の敵への応戦も滑らかなアニメーション（0.7倍速で適度な反応性）
  - 現実的な戦闘動作：即座に向きが変わらず自然な艦隊の動き
- [x] 移動先確定時の選択自動解除機能実装
  - `moveTo()`メソッドに`deselect()`呼び出し追加（回転モードと同様）
  - 艦隊操作の一貫性向上：移動・回転両方で指示確定時に即座に選択解除
  - 連続艦隊指揮効率化：移動指示後すぐに他の艦隊を操作可能
- [x] 移動予定地点プレビュー機能実装
  - 移動モード時に移動予定地点に半透明ゴースト艦隊を表示
  - リアルタイム位置更新：艦隊移動中もゴースト位置が動的更新
  - 到達時自動非表示：目標地点到達時にゴースト艦隊が自動的に消失
- [x] 前方楕円形攻撃システム実装
  - 円形から楕円形射程に変更：横90px×縦180px、前方オフセット配置
  - 現実的な艦隊戦闘を再現した方向性攻撃判定システム
  - 回転モード時の赤色前方楕円表示で戦術的方向制御支援
- [x] 回転モード時の射程表示機能実装
  - 回転モード選択時に赤色の前方楕円形射程を表示
  - 戦術的判断支援：実際の攻撃可能範囲の視覚的確認
  - モード切替時の自動表示/非表示切り替え
- [x] 回転方向確定時の選択自動解除機能実装
  - `rotateTo()`メソッドに`deselect()`呼び出し追加
  - 艦隊操作の連続性向上（回転指示後すぐに他の艦隊操作可能）
  - 戦術的効率化：方向確定後の即座の次行動移行

## Phase 1完了項目
- [x] Node.js環境構築
- [x] PixiJS導入
- [x] Vite開発サーバー設定
- [x] プロジェクト構造作成
- [x] 基本的な画面表示
- [x] 2つの艦隊表示（青い四角：同盟軍、赤い四角：帝国軍）

## Phase 2完了項目
- [x] Fleet クラス実装
- [x] 艦隊のインタラクティブ機能
- [x] 左クリックで艦隊選択（黄色枠表示）
- [x] 右クリックで移動指示
- [x] 滑らかな移動アニメーション
- [x] ゲームループ（ticker）実装

## Phase 3完了項目
- [x] 複数艦隊配置（各陣営3隻ずつ）
- [x] ドラッグ範囲選択機能
- [x] 艦隊HP管理システム（10000HP）
- [x] 自動戦闘システム（射程150px、ダメージ1000、攻撃間隔1秒）
- [x] HPバー表示（色によるHP状態表示）
- [x] 画面上部UI（選択艦隊数、HP表示）
- [x] ファイル構成分離（Fleet.js、Game.js、GameUI.js、main.js）

## Phase 4完了項目
- [x] 包括的UIシステム（上部リソース表示、下部ユニット詳細、ミニマップ）
- [x] ゲーム制御（一時停止、速度変更、音声ミュート）
- [x] 勝利条件システムとゲーム終了画面
- [x] 戦闘統計（撃破数、損失数、ゲーム時間）
- [x] 艦隊の三角形表示と向き表現
- [x] ビジュアルエフェクト（ビーム、爆発パーティクル、ダメージテキスト）
- [x] プロシージャル音響システム（BGM、レーザー音、爆発音、選択音）
- [x] パフォーマンス最適化（画面外カリング、エフェクト数制限）

## Phase 5完了項目（インタラクション強化）
- [x] デュアルモード操作システム
  - 1回クリック: 移動モード（緑色枠表示）
  - ダブルクリック: 回転モード（赤色枠表示）
- [x] モード別右クリック操作
  - 移動モード: 右クリック地点に移動
  - 回転モード: 滑らかな回転アニメーション
- [x] 滑らかな回転アニメーション
  - 目標角度まで徐々に回転（0.03ラジアン/フレーム）
  - 最短回転方向の自動選択
  - 回転中は他の向き変更を無効化
- [x] リアルタイム操作フィードバック
  - UI上でモード表示（[移動]/[回転]/[待機]）
  - コンソールログでデバッグ情報表示

## 次の実装予定（Phase 6）
- 提督システムと特殊能力
- 陣形システムと戦術的移動
- シナリオモードとキャンペーン

## 技術メモ
- PixiJS v8.12.0使用
- Vite開発サーバー（ポート3000-3002）
- 画面サイズ: 1280x720
- ES6モジュール形式
- SQLite3データベース（軍事階級・提督管理システム）

## 操作説明
### 基本操作
- **艦隊選択**: 同盟艦隊（青い三角形）を左クリック
- **ドラッグ選択**: 空白地をドラッグして複数艦隊選択
- **選択解除**: 空白地をクリック

### インタラクションモード
- **1回クリック**: 移動モード（緑色の選択枠）
  - 右クリック先に艦隊が移動
- **ダブルクリック**: 回転モード（赤色の選択枠）
  - 右クリック方向に艦隊が滑らかに回転
  - 戦術的位置取りに重要な方向制御
- **モード表示**: UI上部に現在モードが表示 [移動]/[回転]/[待機]

### 戦術的特徴
- **方向の重要性**: 艦隊の向きが戦闘と戦術に影響
- **滑らかな制御**: ゆっくりとした回転で正確な方向設定
- **優先制御**: 回転中は自動向き変更を無効化

## プロジェクト構造
```
fl/
├── src/
│   ├── index.html      # メインHTML
│   ├── main.js         # エントリーポイント
│   ├── Game.js         # ゲーム管理クラス
│   ├── Fleet.js        # 艦隊クラス
│   ├── GameUI.js       # UI管理クラス（一時停止・速度変更機能追加）
│   └── style.css       # スタイル
├── public/
│   └── assets/         # ゲームアセット
├── database.js         # 階級データベース管理
├── admiral_database.js # 提督データベース管理
├── fleet_database.js   # 艦隊データベース管理
├── database_service.js # ブラウザ用データベースサービス
├── military_ranks.db   # 階級データベースファイル
├── admiral_db.db       # 提督データベースファイル
├── fleet_db.db         # 艦隊データベースファイル
├── .gitignore
├── package.json        # プロジェクト設定（sqlite3追加）
├── vite.config.js      # Vite設定
├── CLAUDE.md           # 開発ログ
└── README.md           # プロジェクト説明
```

## 開発コマンド
- 開発サーバー起動: `npm run dev`
- ビルド: `npm run build`
- プレビュー: `npm run preview`

## 最新更新（Phase 8: UI最適化と操作性向上）
- [x] 上部中央ステータスバー改善
  - 勢力対比表示（同盟軍 VS 帝国軍）の中央配置
  - 初期戦力基準のリアルタイムHPバー（青色・赤色）
  - 艦隊撃破時もバーが正確に戦力減少を反映
  - 劣勢時（HP30%以下）の点滅警告効果
  - 中央VSセパレーターによる勢力区分明確化
- [x] 移動モード操作改善
  - 最小移動距離制限（80px）による誤操作防止
  - ゲームエリア外クリック時の選択解除機能
  - より直感的で戦術的な艦隊移動操作
- [x] ゲームエリア制約システム強化
  - UI画面とゲーム画面の完全分離
  - 操作領域の明確化と視認性向上
  - UIパネル上での右クリック選択解除対応

## 現在の状況
**Phase 8完了**: UI最適化と操作性向上実装済み

### 基本システム
- 黒い宇宙背景 (1280x720)
- ゲームプレイエリア: 300x80から700x580ピクセル（UIエリア除外）
- 自由惑星同盟艦隊（青色三角）3隻: ゲームエリア左側配置（右向き）
- 銀河帝国艦隊（赤色三角）3隻: ゲームエリア右側配置（左向き）
- HP管理: 各艦隊10000HP、攻撃力1000、射程150px
- 包括的UI: 上部統計、下部詳細、右下ミニマップ、右上制御ボタン

### Phase 6新機能
#### 艦隊識別システム
- **艦隊番号**: 各艦隊に1-3の番号表示（白色・太字・縁取り）
- **回転連動**: 艦隊の向きに応じて番号も回転
- **ゴースト番号**: 移動予定地点にも番号付き半透明艦隊表示

#### ZOCベース戦術システム
- **ZOC範囲**: 200px円形の紫色支配領域
- **自動追尾**: ZOC内敵艦隊への滑らかな自動回転
- **戦場の霧**: ZOC範囲外の敵艦隊を自動非表示
- **視界管理**: 複数艦隊のZOC範囲を結合した総合視界

#### 戦闘システム強化
- **戦闘時視界**: 攻撃・被攻撃中の敵艦隊を特例表示
- **時間継続**: 戦闘後1秒間の視界継続でより自然な表現
- **陣営対峙**: 同盟軍（右向き）vs 帝国軍（左向き）の初期配置

#### バグ修正・改善
- **完全削除**: 艦隊撃破時のゴースト艦隊残存バグを修正
- **メモリ管理**: destroy()メソッドで完全クリーンアップ
- **エラー処理**: try-catch による安全な削除処理

### Phase 7新機能
#### UI総合改善システム
- **左側艦隊情報パネル**: 選択艦隊の詳細情報と状態表示
- **右側戦術情報パネル**: 戦況・戦力比・撃破統計の可視化
- **下部コマンドパネル**: モード切替と艦隊操作ボタン群
- **統合UIデザイン**: ダークテーマによる一貫したデザイン

#### ゲームエリア制限システム（Phase 7追加）
- **ゲームプレイエリア定義**: 300x80から700x580ピクセルの制限エリア
- **UIパネル回避**: 左側300px、上部80px、右側280px、下部60pxのUIエリアを回避
- **艦隊配置最適化**: 初期配置をゲームエリア内に調整
- **移動制限**: 艦隊の移動と位置をゲームエリア内に自動制限
- **クリック制限**: ゲームエリア外のクリック・ドラッグ操作を無効化

#### ユーザビリティ向上
- **情報密度最適化**: 必要な情報を効率的に配置
- **視認性向上**: コントラストと色分けによる情報の明確化
- **操作性改善**: 直感的なボタン配置とホバーエフェクト
- **リアルタイム更新**: 戦闘進行に応じた動的情報表示
- **操作領域明確化**: ゲームプレイエリアとUIエリアの明確な分離
- ビジュアルエフェクト: ビーム攻撃、爆発、ダメージ数値
- 音響システム: BGM、レーザー音、爆発音、選択音
- デュアルモード操作: 移動モード（緑枠）・回転モード（赤枠）
- 現実的艦隊機動: 回転完了後に移動実行、戦闘時滑らか回転、移動先ゴースト艦隊完全継続表示
- ZOC（支配領域）システム: 敵侵入検出・自動追尾回転（手動操作優先制御）

## 操作方法（Phase 5）
- **1回クリック**: 移動モード（緑色選択枠）
- **ダブルクリック**: 回転モード（赤色選択枠、前方楕円射程・紫色ZOC範囲表示）
- **右クリック**: モード別操作（移動/回転）
- **移動機動**: 進行方向に回転完了後に移動実行
- **ドラッグ選択**: 左クリック＋ドラッグで範囲選択（同盟軍のみ）
- **自動戦闘**: 前方楕円形射程内の敵を自動攻撃（滑らか応戦回転）
- **UI制御**: 一時停止、速度変更（0.5x/1x/2x）、音声ミュート
- **司令官情報表示**: 艦隊選択時に左側パネルで指揮系統情報を表示
- **勝利条件**: 敵陣営全滅でゲーム終了

## マスターデータ管理システム（JSONベース）
### 提督データ管理
- **ファイル**: `data/admirals.json`
- **構造**: 提督ID、氏名、年齢、階級、陣営、11種類の能力値
- **能力値**: mobility, attack, defense, command, tactics, leadership, intelligence, logistics, diplomacy, morale, experience
- **範囲**: 各能力値は0-120の数値
- **登録提督**: ヤン・ウェンリー、ラインハルト、ビッテンフェルト、ミッターマイヤー、ロイエンタール

### 艦隊データ管理
- **ファイル**: `data/fleets.json`
- **構造**: 艦隊ID、艦隊名、陣営、種別、艦船数、火力、指揮系統
- **指揮系統**: commander（司令官）、viceCommander（副司令官）、staffOfficer（参謀）
- **役職制限**: 各役職は提督IDで管理、兼務禁止

### 階級システム
- **統合管理**: admirals.jsonに階級情報を統合
- **階級データ**: 元帥、大将、中将、少将、准将、大佐、中佐、少佐、大尉、中尉

### ゲーム内統合
- **DatabaseService**: JSON非同期読み込みサービス
- **fetch API**: ブラウザ環境でJSONファイルを動的読み込み
- **艦隊クリック時表示**: 左側パネルに司令官情報（階級・氏名・年齢）を表示
- **能力値連動**: 提督の能力値に基づく艦隊性能の動的調整

## Phase 9新機能（提督能力値システム）
### 提督能力値連動システム
- **移動速度**: 提督の機動値（mobility）に基づく艦隊移動速度調整
  - 基準値60、比率計算: (機動値-60)/30 + 0.8
  - 範囲: 0.8倍～2.0倍の動的調整
- **回転速度**: 提督の機動値に基づく艦隊回転速度調整
  - 移動速度と同じ比率で回転速度も連動調整
- **攻撃力**: 提督の攻撃値（attack）に基づく艦隊攻撃力調整
  - 基準値60、比率計算: (攻撃値-60)/30 + 0.7
  - 範囲: 0.7倍～1.8倍の動的調整
- **防御力**: 提督の防御値（defense）に基づく艦隊防御力調整
  - 基準値60、比率計算: (防御値-60)/30 + 0.7
  - 範囲: 0.7倍～1.8倍の動的調整

### ダメージ計算システム
- **ダメージ計算式**: `finalDamage = Math.max(Math.round(baseDamage * 0.2), baseDamage - target.defensePower)`
- **最小ダメージ保証**: 基本ダメージの20%を下限として設定
- **整数値計算**: すべてのダメージ値を整数で処理
- **防御力考慮**: ターゲットの防御力を基本ダメージから減算

### UI表示強化
- **攻撃力・防御力表示**: 艦隊詳細情報に攻撃力・防御力を追加表示
- **提督補正反映**: 基本値に提督能力値による補正を適用した実際の値を表示
- **リアルタイム更新**: 提督能力値の変更が即座にUI表示に反映

### 性能計算メソッド
- `updateFleetPerformance()`: 提督能力値に基づく艦隊性能更新
- `getAttackPower()`: 現在の攻撃力取得
- `getDefensePower()`: 現在の防御力取得
- 提督情報読み込み時の自動性能更新